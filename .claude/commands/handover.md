# プロジェクト完全引き継ぎ（セッション記録版）

セッション内容を含む完全な引き継ぎファイルを `.claude/handover.txt` に自動生成します。

## 実行内容

### 1. プロジェクト静的情報の収集（既存機能）
`generate_handover.sh` を実行して以下を収集：
- プロジェクト構造、重要ファイル
- Git状態
- 実験駆動型開発の状況
- 環境・設定情報

### 2. セッション内容の解析（新機能）
最新のセッションログ（`.claude/full_text_logs/`）を解析して以下を抽出：

**a) 実施した作業内容**
- 変更したファイルとその内容
- 実行したコマンド
- 追加・修正した機能

**b) 会話・議論の要点**
- ユーザーからの要求
- 技術的な議論のポイント
- 重要な決定事項

**c) 実装の意図と判断理由**
- なぜその実装方法を選んだか
- どのような制約・前提があったか
- 代替案とその却下理由

**d) 失敗した試みと学び**
- うまくいかなかった実装
- エラーとその原因
- 回避策・解決策

**e) 次のセッションへの引き継ぎ**
- 未完了のタスク（具体的に）
- 次にやるべきこと
- 注意すべきポイント

## 実行手順

### Step 1: 静的情報を更新とgitコミット（v10.6.4）
```bash
./.claude/generate_handover.sh
```
これにより：
- プロジェクト静的情報が最新状態に更新されます
- 既存のセッション履歴は**保持**されます（消えません）
- **重要**: handover.txtの完全版が自動的にgitコミットされます（データ保護）
- 1400行を超えた場合、自動的に要約プロセスが起動します

### Step 2: 要約プロセス（v10.6.4 - 1400行超過時のみ）

handover.txtが1400行を超えた場合、以下のプロセスが**自動的に**実行されます：

1. **行数チェック**:
   - 1400行以下 → 要約スキップ、終了
   - 1400行超 → 要約プロセス開始

2. **セッション履歴の解析**:
   - セッション数をカウント（`## 💬 セッション` の数）
   - 5セッション以下 → 要約不要、終了
   - 6セッション以上 → 古いセッションを要約

3. **要約案の提示**:
   - 古いセッション（直近5件以前）を1行要約
   - 直近5セッションは詳細を保持
   - 要約プレビューを表示

4. **ユーザー承認待ち**:
   - 要約を実行するか確認（y/N）
   - N の場合、要約をスキップ
   - Y の場合、要約版で上書き

5. **要約実行**:
   - 静的情報 + 要約版セッション履歴 + 直近5セッション詳細 で再構成
   - handover.txtを上書き（完全版はgit履歴に残る）
   - **注意**: 要約版はgitコミットしない（次回handoverで完全版に戻る）

**要約フローの安全性**:
- ✅ 完全版は必ずgitコミット済み（要約前）
- ✅ 要約失敗してもgit履歴から復元可能
- ✅ 手動承認制（自動実行しない）
- ✅ `/load-context` で読み込み可能な行数（2000行以下）を維持

### Step 3: セッション内容を解析・追記

以下を**自動的に**実行してください：

1. **最新セッションログを特定**:
   - `.claude/full_text_logs/` 内の最新ファイルを特定
   - ファイル名から日時を抽出

2. **セッションログを読み込み**:
   - Readツールで最新ログを読み込む
   - ログファイルが大きい場合は末尾を優先的に読む
   - エスケープシーケンス（`\033[...m`、`[2K`など）は無視して内容を抽出

3. **会話内容を解析**して以下を抽出:

   **a) 実施した作業**:
   - Editツールで変更したファイルとその変更内容
   - Writeツールで作成したファイル
   - Bashツールで実行したコマンド
   - どんな機能を追加・修正したか

   **b) 重要な会話・議論**:
   - ユーザーの要求内容
   - 技術的な議論のポイント
   - 「なぜその方法を選んだか」の説明

   **c) 判断と決定事項**:
   - 設計上の重要な決定
   - 採用したアプローチとその理由
   - 却下した代替案とその理由

   **d) 失敗・エラー・問題**:
   - 発生したエラーメッセージ
   - うまくいかなかった実装
   - その原因と解決策
   - まだ解決していない問題

   **e) 次のアクション**:
   - 未完了のタスク（具体的に）
   - 次にやるべきこと（優先順位付き）
   - 注意すべきポイント・制約

4. **セッション情報を追記**:

   **重要**: 既存の `.claude/handover.txt` を読み込み、「# 📚 セッション履歴」セクションの**末尾**に追記してください。

   追記する内容：

   ```markdown
   ## 💬 セッション [日時]

   **セッション時刻**: [ログから抽出した開始-終了時刻]
   **作業時間**: [推定時間]

   ### 🎯 実施した作業
   - [変更したファイル1: 変更内容の要約]
   - [変更したファイル2: 変更内容の要約]
   - [実行したコマンド]
   - [追加した機能]

   ### 💭 重要な会話・議論
   - [ユーザーからの主要な要求]
   - [技術的な議論のポイント]
   - [重要な決定事項]

   ### 🔧 実装の意図と判断
   - **採用した方法**: [何をどう実装したか]
   - **理由**: [なぜその方法を選んだか]
   - **制約・前提**: [考慮した制約条件]
   - **却下した代替案**: [検討したが採用しなかった方法とその理由]

   ### ⚠️ 問題・エラー・失敗
   - **発生した問題**: [エラー内容]
   - **原因**: [なぜ発生したか]
   - **解決策**: [どう解決したか、または未解決]
   - **学び**: [今後に活かせること]

   ### ▶️ 次のアクション
   #### 未完了タスク
   - [ ] [具体的なタスク1]
   - [ ] [具体的なタスク2]

   #### 優先事項
   1. [最優先でやるべきこと]
   2. [次に重要なこと]

   #### 注意点
   - [次のセッションで気をつけるべきこと]
   - [重要な制約や前提条件]

   ---
   ```

   **追記方法**:
   - Readツールで `.claude/handover.txt` 全体を読み込む
   - 「# 📚 セッション履歴」セクションを見つける
   - その末尾に新しいセッション記録を追加
   - Editツールで更新（または全体を書き直し）

## 期待される出力形式

`.claude/handover.txt` は以下の構造になります：

```markdown
# 🔄 プロジェクト引き継ぎ文書

**最終更新日時**: 2025-11-08 17:39:00
**生成スクリプト**: generate_handover.sh v1.0.0

---

# 🏠 プロジェクト基本情報
[プロジェクト構造、重要ファイル等]

# 📁 バージョン管理情報
[Git状態、変更ファイル等]

# 🧪 実験駆動型開発の状況
[アクティブな実験、完了した実験等]

# ⚙️ 環境・設定情報
[システム情報、Claude Code環境等]

# 💬 最新セッション情報
[最新セッションログの概要、タスク状況]

# ⚠️ 引き継ぎ時の注意事項
[重要な制約、確認ポイント等]

---

# 📚 セッション履歴

## 💬 セッション 2025-11-08 11:03-17:39

**セッション時刻**: 2025-11-08 11:03 - 17:39
**作業時間**: 約6.5時間

### 🎯 実施した作業
- `.claude/generate_handover.sh` を修正: セッション履歴保持機能を追加
- `.claude/commands/handover-full2.md` を作成: セッション内容自動記録機能
- バグ修正: handover.txt の履歴が消える問題を解決

### 💭 重要な会話・議論
- コンパクティング vs 手動セッション切り替えの議論 → 継続作業が正解
- `/handover-full` でセッション履歴が消えるバグの発見
- 完全自動化の要求（手動振り返りは却下）

### 🔧 実装の意図と判断
- **採用した方法**: 静的情報とセッション履歴を分離、履歴は追記方式
- **理由**: 過去のセッション記録を保持しながら、プロジェクト状態も最新化
- **実装詳細**:
  - generate_handover.sh: 既存履歴を一時保存 → 静的情報更新 → 履歴復元
  - handover-full2: セッションログ解析 → 履歴セクションに追記

### ⚠️ 問題・エラー・失敗
- **問題**: 初期設計ではセッション履歴が毎回消えていた
- **原因**: `>` による上書きで過去の記録が失われていた
- **解決**: `sed`で履歴部分を抽出・保存 → 復元する方式に変更

### ▶️ 次のアクション
#### 未完了タスク
- [ ] `/handover-full2` の動作確認
- [ ] 実際のプロジェクトでテスト実行

#### 優先事項
1. このプロジェクト自身で `/handover-full2` を試用
2. lebowskigame プロジェクトで失われた履歴の復旧（可能なら）

#### 注意点
- 大きなセッションログでの性能確認が必要
- エスケープシーケンス除去の動作検証

---

## 💬 セッション 2025-11-07 14:00-16:00
[前回のセッション記録...]

---
```

**ポイント**:
- 静的情報は毎回更新（最新状態を保つ）
- セッション履歴は追記され続ける（消えない）
- 各セッションは `---` で区切られる

## 使用タイミング

**重要**: このコマンドはセッション終了のためではなく、**チェックポイント作成**のためです。

### 推奨タイミング：
- **区切りの良いタイミング**: 機能実装完了時、大きな作業の終了時
- **定期的に**: 1-2時間ごと、またはトークン使用量が一定以上になったとき
- **コンパクティング前**: Claude Codeが文脈圧縮する前に記録を保存

### 実行後の運用：
1. `/handover-full2` 実行 → handover.txt更新
2. **セッションは継続** （閉じない）
3. そのまま作業を続ける
4. コンパクティングが来たら → 「handover.txt読んで文脈復元して」

### メリット：
- ✅ 作業の連続性を保ちながら、バックアップも確保
- ✅ コンパクティング後も文脈を復元可能
- ✅ 過去のセッション履歴も参照可能

## 注意事項

- セッションログが大きい場合（100MB超）、読み込みに時間がかかる可能性があります
- エスケープシーケンスは自動的に無視されますが、一部残る場合があります
- 重要な会話内容は自動抽出されますが、特に重要な判断は明示的に記録することを推奨します

---

## Step 最終: トークン残量の報告（v10.6.3）

handover実行が完了したら、現在のトークン使用状況を以下の形式で報告してください：

```markdown
✅ handover完了

## 📊 トークン使用状況

**使用量**: [使用トークン数] / 200,000 ([使用パーセント]%)
**残量**: [残りトークン数] ([残量パーセント]%)

**評価**: [健全性評価]
```

**健全性評価の基準**:
- **🟢 健全 (60%以上残)**: まだ余裕があります。このまま作業を継続できます
- **🟡 注意 (40-60%残)**: 適度に使用中。継続的な作業が可能です
- **🟠 警戒 (20-40%残)**: 残量が減ってきました。こまめなhandoverを推奨します
- **🔴 危険 (20%未満)**: コンパクティングが近いです。早めに `/handover` を実行することを推奨します
